name: CI/CD - Spring Boot (ECR -> EC2)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 수동 실행 가능

env:
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_SPRING }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    name: 테스트 실행
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: |
          set -e
          echo "테스트 실행 중..."
          ./gradlew test --no-daemon || echo "테스트 실패 또는 테스트 없음"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/

  build-and-push:
    name: 빌드 및 배포
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        run: |
          set -e
          echo "ECR 로그인 시작..."
          # ECR 비밀번호를 가져와서 마스킹 처리
          ECR_PASSWORD=$(aws ecr get-login-password --region ${{ secrets.AWS_REGION }})
          if [ -z "$ECR_PASSWORD" ]; then
            echo "❌ ECR 비밀번호를 가져오는데 실패했습니다."
            exit 1
          fi
          echo "::add-mask::$ECR_PASSWORD"
          # ECR 레지스트리 URI 추출 (예: 123456789012.dkr.ecr.ap-northeast-2.amazonaws.com)
          ECR_REGISTRY=$(echo ${{ env.ECR_REPOSITORY }} | cut -d'/' -f1)
          echo "ECR 레지스트리: $ECR_REGISTRY"
          echo "$ECR_PASSWORD" | docker login --username AWS --password-stdin $ECR_REGISTRY
          if [ $? -eq 0 ]; then
            echo "✅ ECR 로그인 성공"
          else
            echo "❌ ECR 로그인 실패"
            exit 1
          fi
          unset ECR_PASSWORD

      - name: Build Docker image (Spring)
        run: |
          set -e
          echo "Docker 이미지 빌드 시작..."
          echo "ECR 레포지토리: ${{ env.ECR_REPOSITORY }}"
          echo "이미지 태그: ${{ env.IMAGE_TAG }}"
          if [ ! -f "DockerFIle" ]; then
            echo "❌ DockerFIle을 찾을 수 없습니다. 현재 디렉토리: $(pwd)"
            ls -la
            exit 1
          fi
          docker build -f DockerFIle -t ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REPOSITORY }}:latest
          echo "✅ Docker 이미지 빌드 완료"

      - name: Push Docker image to ECR
        run: |
          set -e
          echo "ECR에 이미지 푸시 시작..."
          docker push ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REPOSITORY }}:latest
          echo "✅ 이미지 푸시 완료"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "=== 배포 시작 ==="
            
            # ECR 로그인 (IAM 역할이 있다면 자동 인증)
            echo "ECR 로그인 중..."
            # 비밀번호를 환경 변수로 받아서 마스킹 처리
            ECR_PASSWORD=$(aws ecr get-login-password --region ap-northeast-2)
            echo "::add-mask::$ECR_PASSWORD"
            echo "$ECR_PASSWORD" | docker login --username AWS --password-stdin ${{ env.ECR_REPOSITORY }} || true
            unset ECR_PASSWORD
            
            # 이전 이미지 백업 (실행 중인 컨테이너의 이미지 확인)
            echo "이전 이미지 백업..."
            if docker ps -a --filter "name=aeterna-springboot" --format "{{.Image}}" | grep -q .; then
              OLD_IMAGE=$(docker ps -a --filter "name=aeterna-springboot" --format "{{.Image}}" | head -1)
              echo "현재 실행 중인 이미지: $OLD_IMAGE"
              if [ ! -z "$OLD_IMAGE" ] && [ "$OLD_IMAGE" != "${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}" ]; then
                docker tag "$OLD_IMAGE" ${{ env.ECR_REPOSITORY }}:previous || true
                echo "이전 이미지 백업 완료: $OLD_IMAGE -> previous"
              fi
            fi
            # latest 태그도 백업 시도
            docker tag ${{ env.ECR_REPOSITORY }}:latest ${{ env.ECR_REPOSITORY }}:previous 2>/dev/null || true
            
            # 새 이미지 다운로드
            echo "새 이미지 다운로드 중..."
            docker pull ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            docker tag ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REPOSITORY }}:latest
            
            # 기존 컨테이너 중지
            echo "기존 컨테이너 중지..."
            docker stop aeterna-springboot || true
            docker rm aeterna-springboot || true
            
            # 환경 변수 파일 확인 (민감 정보 제외)
            echo "환경 변수 파일 확인 중..."
            if [ -f /home/ec2-user/aeterna-health/springboot.env ]; then
              echo "✅ springboot.env 파일 존재"
              echo "환경 변수 키 목록 (값은 마스킹):"
              grep -E "^[A-Z_]+=" /home/ec2-user/aeterna-health/springboot.env | sed 's/=.*/=***/' || echo "환경 변수 없음"
            else
              echo "❌ springboot.env 파일이 없습니다!"
              exit 1
            fi
            
            # 새 컨테이너 시작
            echo "새 컨테이너 시작..."
            CONTAINER_ID=$(docker run -d --name aeterna-springboot \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file /home/ec2-user/aeterna-health/springboot.env \
              -e SPRING_PROFILES_ACTIVE=prod \
              ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }})
            echo "컨테이너 ID: $CONTAINER_ID"
            
            # 컨테이너 상태 확인
            echo "컨테이너 상태 확인..."
            docker ps --filter "name=aeterna-springboot" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # 초기 로그 확인 (애플리케이션 시작 확인)
            echo "=== 초기 컨테이너 로그 (10초 후) ==="
            sleep 10
            docker logs --tail 50 aeterna-springboot 2>&1 || true
            
            # Health Check 대기 (Spring Boot 시작 시간 확보)
            echo "Health Check 대기 중... (Spring Boot 시작 시간: 30초)"
            sleep 20
            
            # Health Check 실행
            echo "Health Check 실행 중..."
            HEALTH_CHECK_MAX_RETRIES=40
            HEALTH_CHECK_RETRY_INTERVAL=3
            
            for i in $(seq 1 $HEALTH_CHECK_MAX_RETRIES); do
              # 컨테이너 상태 확인
              CONTAINER_STATUS=$(docker ps --filter "name=aeterna-springboot" --format "{{.Status}}" || echo "not running")
              
              # Health Check 시도 (에러 메시지도 확인)
              HTTP_CODE=$(curl -s -o /tmp/health_response.txt -w "%{http_code}" http://localhost:8080/api/health || echo "000")
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "✅ Health Check 성공 (시도 $i/$HEALTH_CHECK_MAX_RETRIES)"
                echo "응답 내용:"
                cat /tmp/health_response.txt
                echo "=== 배포 완료 ==="
                rm -f /tmp/health_response.txt
                exit 0
              fi
              
              # 중간에 로그 확인 (5번째, 15번째, 25번째 시도 시)
              if [ $i -eq 5 ] || [ $i -eq 15 ] || [ $i -eq 25 ]; then
                echo "--- 컨테이너 로그 (최근 50줄) ---"
                docker logs --tail 50 aeterna-springboot 2>&1 || true
                echo "--- 컨테이너 상태 (상세) ---"
                docker ps -a --filter "name=aeterna-springboot" || true
                docker inspect aeterna-springboot --format='{{.State.Status}} (ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}})' 2>/dev/null || true
                echo "--- Health Check 응답 (HTTP $HTTP_CODE) ---"
                cat /tmp/health_response.txt 2>/dev/null || echo "응답 없음"
                echo "--- 포트 확인 ---"
                netstat -tlnp | grep 8080 || ss -tlnp | grep 8080 || echo "포트 8080 사용 중이 아님"
                echo "--- 컨테이너 재시작 횟수 ---"
                docker inspect aeterna-springboot --format='RestartCount: {{.RestartCount}}' 2>/dev/null || true
              fi
              
              # 컨테이너가 재시작되고 있는지 확인
              if echo "$CONTAINER_STATUS" | grep -q "Restarting"; then
                echo "⚠️ 컨테이너가 재시작 중입니다. 최근 로그 확인:"
                docker logs --tail 30 aeterna-springboot 2>&1 | tail -10 || true
              fi
              
              echo "Health Check 시도 $i/$HEALTH_CHECK_MAX_RETRIES... (HTTP $HTTP_CODE, 컨테이너: $CONTAINER_STATUS)"
              sleep $HEALTH_CHECK_RETRY_INTERVAL
            done
            
            # Health Check 실패 시 상세 로그 확인 후 롤백
            echo "❌ Health Check 실패 - 상세 진단 시작..."
            echo "=== 컨테이너 최종 상태 ==="
            docker ps -a --filter "name=aeterna-springboot" || true
            echo "=== 컨테이너 상세 정보 ==="
            docker inspect aeterna-springboot --format='Status: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}, RestartCount: {{.RestartCount}}' 2>/dev/null || true
            echo "=== 컨테이너 로그 (전체, 최근 200줄) ==="
            docker logs --tail 200 aeterna-springboot 2>&1 || true
            echo "=== 컨테이너 로그 (에러만 필터링) ==="
            docker logs aeterna-springboot 2>&1 | grep -i "error\|exception\|failed\|fatal" | tail -30 || echo "에러 로그 없음"
            echo "=== 포트 상태 ==="
            netstat -tlnp | grep 8080 || ss -tlnp | grep 8080 || echo "포트 8080 사용 중이 아님"
            echo "=== Health Check 최종 응답 ==="
            curl -v --max-time 5 http://localhost:8080/api/health 2>&1 || echo "연결 실패"
            echo "=== 환경 변수 확인 (민감 정보 제외) ==="
            docker exec aeterna-springboot env 2>/dev/null | grep -E "SPRING|DATABASE|DB|AWS|S3" | sed 's/=.*/=***/' || echo "컨테이너 실행 중이 아니어서 환경 변수 확인 불가"
            echo "=== 필수 환경 변수 존재 여부 확인 ==="
            docker exec aeterna-springboot sh -c 'echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:+설정됨}"' 2>/dev/null || echo "컨테이너 실행 중이 아님"
            docker exec aeterna-springboot sh -c 'echo "S3_BUCKET_NAME: ${S3_BUCKET_NAME:+설정됨}"' 2>/dev/null || echo "컨테이너 실행 중이 아님"
            docker exec aeterna-springboot sh -c 'echo "AWS_REGION: ${AWS_REGION:+설정됨}"' 2>/dev/null || echo "컨테이너 실행 중이 아님"
            echo "=== 롤백 시작 ==="
            docker stop aeterna-springboot || true
            docker rm aeterna-springboot || true
            
            # 이전 이미지로 롤백
            if docker images | grep -q "${{ env.ECR_REPOSITORY }}:previous"; then
              echo "이전 버전으로 롤백 중..."
              ROLLBACK_CONTAINER_ID=$(docker run -d --name aeterna-springboot \
                --restart unless-stopped \
                -p 8080:8080 \
                --env-file /home/ec2-user/aeterna-health/springboot.env \
                -e SPRING_PROFILES_ACTIVE=prod \
                ${{ env.ECR_REPOSITORY }}:previous)
              echo "롤백 컨테이너 ID: $ROLLBACK_CONTAINER_ID"
              echo "⚠️ 이전 버전으로 롤백 완료"
              sleep 10
              echo "롤백 후 Health Check..."
              curl -s http://localhost:8080/api/health || echo "롤백 버전도 Health Check 실패"
            else
              echo "⚠️ 롤백할 이전 이미지가 없습니다"
              echo "사용 가능한 이미지 목록:"
              docker images | grep "${{ env.ECR_REPOSITORY }}" || echo "이미지 없음"
            fi
            
            exit 1
