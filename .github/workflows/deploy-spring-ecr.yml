name: CI/CD - Spring Boot (ECR -> EC2)

on:
  push:
    branches: [ release ]
  workflow_dispatch:

env:
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_SPRING }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: 빌드 및 배포
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          set -e
          ECR_PASSWORD=$(aws ecr get-login-password --region ${{ secrets.AWS_REGION }})
          ECR_REGISTRY=$(echo "${{ env.ECR_REPOSITORY }}" | cut -d'/' -f1)
          echo "$ECR_PASSWORD" | docker login --username AWS --password-stdin "$ECR_REGISTRY"
          unset ECR_PASSWORD

      - name: Build Docker image (Spring)
        run: |
          set -e
          if [ ! -f "Dockerfile" ]; then
            echo "❌ Dockerfile을 찾을 수 없습니다. 현재 디렉토리: $(pwd)"
            ls -la
            exit 1
          fi

          docker build -f Dockerfile -t ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REPOSITORY }}:latest

      - name: Push Docker image to ECR
        run: |
          set -e
          docker push ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REPOSITORY }}:latest

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "=== 배포 시작 ==="

            # EC2에서 ECR 로그인
            ECR_PASSWORD=$(aws ecr get-login-password --region ap-northeast-2)
            ECR_REGISTRY=$(echo "${{ env.ECR_REPOSITORY }}" | cut -d'/' -f1)
            echo "$ECR_PASSWORD" | docker login --username AWS --password-stdin "$ECR_REGISTRY"
            unset ECR_PASSWORD

            # 새 이미지 pull
            docker pull ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            docker tag ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.ECR_REPOSITORY }}:latest

            # 기존 컨테이너 교체
            docker stop aeterna-springboot || true
            docker rm aeterna-springboot || true

            docker run -d --name aeterna-springboot \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file /home/ec2-user/aeterna-health/springboot.env \
              -e SPRING_PROFILES_ACTIVE=prod \
              ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

            echo "=== 배포 완료 ==="
